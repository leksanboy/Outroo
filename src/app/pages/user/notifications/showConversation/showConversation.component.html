<div class="dialogBox">
	<span *ngIf="data.comeFrom == 'new'">
		<div mat-dialog-title class="header">
			<button mat-icon-button (click)="dialogRef.close()"><mat-icon>arrow_back</mat-icon></button>
			<div class="text">New chat</div>
		</div>

		<div mat-dialog-content class="bodyChat">
			<div class="container">
				<div class="searchBox">
					<div class="box">
						<form [formGroup]="actionFormSearch" (ngSubmit)="search('send')">
							<div class="inner">
								<mat-icon>search</mat-icon>

								<div class="chips">
									<mat-chip-list matPrefix>
										<mat-chip *ngFor="let x of data.chatUsers">
											<div class="avatar">
												<img [src]="x.user.avatar ? x.user.avatarUrl : environment.avatar"/>
											</div>
											<span class="name">{{x.user.username}}</span>
											<mat-icon (click)="addUserToNewChat(x)">clear</mat-icon>
										</mat-chip>

										<input type="text" placeholder="Search" formControlName="caption">
									</mat-chip-list>
								</div>

								<button mat-icon-button type="button" *ngIf="actionFormSearch.controls.caption.value.length > 0" (click)="search('clear')">
									<mat-icon>clear</mat-icon>
								</button>
							</div>
						</form>
					</div>
				</div>

				<div class="container">
					<span *ngIf="data.active == 'default'">
						<ul class="searchUsersList" *ngIf="dataDefault.list.length > 0">
							<li *ngFor="let x of dataDefault.list" (click)="addUserToNewChat(x);">
								<div class="avatar">
									<img [src]="x.user.avatar ? x.user.avatarUrl : environment.avatar"/>
								</div>
								<div class="text">
									<span class="username">{{x.user.username}}</span>
									<br>
									<span class="about">{{x.about.trim() ? x.about : x.user.name}}</span>
								</div>
								<div class="actions">
									<span *ngIf="x.added"><mat-icon>check_circle</mat-icon></span>
									<span *ngIf="!x.added"><mat-icon>radio_button_unchecked</mat-icon></span>
								</div>
							</li>
						</ul>

						<div class="loadingData" *ngIf="dataDefault.loadingData">
							<mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
						</div>
						<div class="noData" *ngIf="dataDefault.noData">No data</div>
					</span>

					<span *ngIf="data.active == 'search'">
						<ul class="searchUsersList" *ngIf="dataSearch.list.length > 0">
							<li *ngFor="let x of dataSearch.list" (click)="addUserToNewChat(x);">
								<div class="avatar">
									<img [src]="x.user.avatar ? x.user.avatarUrl : environment.avatar"/>
								</div>
								<div class="text">
									<span class="username">{{x.user.username}}</span>
									<br>
									<span class="about">{{x.about.trim() ? x.about : x.user.name}}</span>
								</div>
								<div class="actions">
									<span *ngIf="x.added"><mat-icon>check_circle</mat-icon></span>
									<span *ngIf="!x.added"><mat-icon>radio_button_unchecked</mat-icon></span>
								</div>
							</li>
						</ul>

						<div class="loadingData" *ngIf="dataSearch.loadingData">
							<mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
						</div>
						<div class="noData" *ngIf="dataSearch.noData">No results</div>
						<div class="loadMore" *ngIf="dataSearch.loadMoreData">
							<button mat-fab (click)="search('more')" *ngIf="!dataSearch.loadingMoreData">
								<mat-icon>add</mat-icon>
							</button>
							<mat-progress-spinner mode="indeterminate" *ngIf="dataSearch.loadingMoreData"></mat-progress-spinner>
						</div>
					</span>
				</div>
			</div>
		</div>

		<div mat-dialog-actions class="buttons">
			<button mat-button type="button" [disabled]="data.chatUsers.length == 0" (click)="initNewChat()">
				<mat-progress-spinner mode="indeterminate" *ngIf="saveLoading"></mat-progress-spinner>
				Init Chat
			</button>
		</div>
	</span>

	<span *ngIf="!showUsers && data.comeFrom == 'conversation'">
		<div mat-dialog-title class="header">
			<button mat-icon-button (click)="dialogRef.close()"><mat-icon>arrow_back</mat-icon></button>
			<div class="text">
				<span *ngFor="let u of chatData.users | slice: 0:5; let isLast = last;">
					<span class="username">
						{{u.user.username}}{{isLast ? '' : ', '}}
					</span>
				</span>
			</div>
			<button mat-icon-button (click)="showUsers=!showUsers">
				<mat-icon>info_outline</mat-icon>
			</button>
		</div>

		<div mat-dialog-content class="bodyChat" #conversationContainer>
			<div class="container">
				<ul class="conversationList" *ngIf="chatData.conversation.length > 0">
					<li *ngFor="let x of chatData.conversation; let i = index;" [ngClass]="{'me': sessionData.current.id == x.user.id}" [@showFromBottomAnimation]>
						<div class="box">
							<div class="top" *ngIf="!((i > 0) && (x.user.id == chatData.conversation[i-1].user.id))">
								<a class="avatar" routerLink="/{{x.user.username}}">
									<img [src]="x.user.avatar ? x.user.avatarUrl : environment.avatar"/>
								</a>
								<div class="name">
									<span class="username">{{x.user.username}}</span>
									<span class="date"> Â· {{x.date | timeago}}</span>
								</div>
							</div>
							<div class="bottom">
								<div class="text" *ngIf="x.type == 'text'" [innerHtml]="x.content | safeHtml"></div>

								<div class="publication" *ngIf="x.type == 'publication'">
									<div class="user">
										<div class="avatar">
											<img [src]="x.publication.user.avatar ? x.publication.user.avatarUrl : environment.avatar"/>
										</div>
										<div class="name">
											{{x.publication.user.username}}
										</div>
									</div>

									<div class="urlVideo" *ngIf="x.publication.urlVideo">
										<div class="embedResponsive">
											<div class="image" (click)="x.publication.urlVideo.showVideo=!x.publication.urlVideo.showVideo" *ngIf="!x.publication.urlVideo.showVideo">
												<div class="img" [ngStyle]="{'background-image': 'url(' + x.publication.urlVideo.thumbnail + ')'}"></div>
												<div class="play"><mat-icon>play_arrow</mat-icon></div>
												<div class="type">{{x.publication.urlVideo.type}}</div>
											</div>
											<span [innerHtml]="x.publication.urlVideo.iframe | safeHtml" *ngIf="x.publication.urlVideo.showVideo"></span>
										</div>
									</div>

									<div class="photos" *ngIf="x.publication.photos">
										<img *ngIf="x.publication.photos[0].mimetype.indexOf('image') !== -1" [src]="environment.pathPhotos + x.publication.photos[0].name">
										<video *ngIf="x.publication.photos[0].mimetype.indexOf('video') !== -1" [src]="environment.pathVideos + x.publication.photos[0].name.split('.')[0] + '.mp4'" controls></video>
									</div>

									<div class="textContainer" *ngIf="x.publication.content" [innerHTML]="x.publication.content | safeHtml"></div>

									<div class="audios" *ngIf="x.publication.audios && !x.publication.content">
										<ul>
											<li *ngFor="let a of x.publication.audios">
												<div class="inner">
													<div class="image">
														<button mat-icon-button>
															<mat-icon>play_arrow</mat-icon>
															<img *ngIf="a.image" [src]="environment.pathAudios + 'thumbnails/' + a.image"/>
														</button>
													</div>
													<div class="text">
														<div class="titleArtist" title="{{a.original_title ? a.original_title : a.title}}">
															<div class="title">{{a.original_title ? a.original_title : a.title}}</div>
															<div class="artist">{{a.original_artist ? a.original_artist : a.title}}</div>
														</div>
														<div class="duration">{{a.duration}}</div>
													</div>
												</div>
											</li>
										</ul>
									</div>
								</div>
							</div>
						</div>
					</li>
				</ul>

				<div class="noData" *ngIf="chatData.conversation.length == 0">No data</div>
			</div>
		</div>

		<div mat-dialog-actions class="buttons newChatComment">
			<div class="new">
				<div class="avatar">
					<img [src]="sessionData.current.avatar ? sessionData.current.avatarUrl : environment.avatar"/>
				</div>
				<div class="richComment">
					<div class="highlights" [innerHTML]="data.newCommentData.transformed"></div>
					<div class="origin" contenteditable="plaintext-only" [textContent]="data.newCommentData.onBackground" (input)="newComment('writingChanges', $event.target.innerText, data)" (keyup)="newComment('keyCode', $event, data)" (keydown)="newComment('keyCode', $event, data)" (mouseup)="newComment('keyCode', $event, data)"></div>
				</div>
				<div class="actions">
					<button mat-icon-button type="submit" (click)="newComment('create', $event, data)">
						<mat-icon>send</mat-icon>
					</button>
				</div>
			</div>
		</div>
	</span>

	<span *ngIf="showUsers">
		<div mat-dialog-title class="header">
			<button mat-icon-button (click)="showUsers=!showUsers"><mat-icon>arrow_back</mat-icon></button>
			<div class="text">Details</div>
		</div>

		<div mat-dialog-content class="bodyChat">
			<div class="container">
				<ul class="usersList">
					<li *ngFor="let x of chatData.users; let i=index;">
						<a class="avatar" routerLink="/{{x.user.username}}">
							<img [src]="x.user.avatar ? x.user.avatarUrl : environment.avatar"/>
						</a>
						<a class="text" routerLink="/{{x.user.username}}">
							<span class="username">
								{{x.user.username}}
								<mat-icon mat-icon class="official" *ngIf="x.official" matTooltip="Verified account">check_circle</mat-icon>
							</span>
							<br>
							<span class="about">{{x.user.name}}</span>
						</a>
						<!-- <div class="actions" *ngIf="x.user.id != data.session.id">
							<button mat-button class="border" *ngIf="x.status == 'none'" (click)="followUnfollow('follow', x)">
								Follow
							</button>
							<button mat-button class="border" *ngIf="x.status == 'pending'" [matMenuTriggerFor]="cancelRequest">
								Pending
							</button>
							<button mat-button *ngIf="x.status == 'following'" class="active" [matMenuTriggerFor]="stopFollowing">
								Following
							</button>
							<mat-menu #cancelRequest="matMenu" yPosition="below" xPosition="before" class="removeBox">
								<button mat-menu-item disabled>
									Cancel request
								</button>
								<div class="buttons">
									<button mat-menu-item>No</button>
									<button mat-menu-item (click)="followUnfollow('cancel', x)">Yes</button>
								</div>
							</mat-menu>
							<mat-menu #stopFollowing="matMenu" yPosition="below" xPosition="before" class="removeBox">
								<button mat-menu-item disabled>
									Stop following
									<br>
									{{x.user.username}}?
								</button>
								<div class="buttons">
									<button mat-menu-item>No</button>
									<button mat-menu-item (click)="followUnfollow('cancel', x)">Yes</button>
								</div>
							</mat-menu>
						</div> -->
					</li>
				</ul>
			</div>
		</div>
	</span>
</div>
